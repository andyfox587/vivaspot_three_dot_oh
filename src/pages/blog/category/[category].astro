---
export const prerender = true;

import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogCard from '../../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../../../utils/readingTime';

// BlogCard already uses OptimizedImage internally

// Generate static paths for all categories
export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter(p => p.data.published);

  // Get all unique categories
  const allCategories = [...new Set(publishedPosts.flatMap(p => p.data.categories))];

  return allCategories.map(category => ({
    params: { category: category.toLowerCase().replace(/\s+/g, '-') },
    props: { categoryName: category }
  }));
}

const { category } = Astro.params;
const { categoryName } = Astro.props;

// Get all published posts in this category
const allPosts = await getCollection('blog');
const posts = allPosts
  .filter(p => p.data.published && p.data.categories.includes(categoryName))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get all categories for navigation
const publishedPosts = allPosts.filter(p => p.data.published);
const allCategories = [...new Set(publishedPosts.flatMap(p => p.data.categories))].sort();

// Category descriptions for SEO
const categoryDescriptions: Record<string, string> = {
  'Marketing': 'Learn effective marketing strategies for restaurants, cafes, and retail businesses. Tips on customer acquisition, retention, and building lasting relationships.',
  'Wifi Marketing': 'Discover how to leverage guest WiFi as a powerful marketing tool. Capture leads, build customer databases, and automate engagement through WiFi.',
  'Presence Marketing': 'Explore presence marketing techniques that trigger automated campaigns when customers visit. Win-back campaigns, loyalty rewards, and real-time engagement.',
  'Technology': 'Stay updated on the latest technology trends in hospitality and retail. WiFi solutions, integrations, and tech-driven customer engagement.',
  'Insights': 'Industry insights and analysis to help you understand customer behavior, market trends, and best practices for business growth.',
  'Business': 'Business tips and strategies for restaurant owners, retailers, and hospitality professionals. Grow revenue and improve operations.',
  'Software': 'Software reviews, comparisons, and guides for business owners. CRM, email marketing, POS integrations, and automation tools.',
  'Covid-19': 'Resources and strategies for businesses navigating the pandemic. Contactless solutions, safety protocols, and recovery tips.',
  'Uncategorized': 'General articles and updates from VivaSpot.'
};

const description = categoryDescriptions[categoryName] || `Read our latest articles about ${categoryName}. Tips, guides, and insights for your business.`;

// Breadcrumb schema for SEO
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://vivaspot.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://vivaspot.com/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": categoryName,
      "item": `https://vivaspot.com/blog/category/${category}`
    }
  ]
};
---

<BaseLayout title={`${categoryName} - Blog`} description={description}>
  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <!-- Hero Section -->
  <section class="category-hero">
    <div class="hero-bg"></div>
    <div class="hero-container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span class="separator">/</span>
        <a href="/blog">Blog</a>
        <span class="separator">/</span>
        <span class="current">{categoryName}</span>
      </nav>

      <h1 class="hero-title">{categoryName}</h1>
      <p class="hero-subtitle">{description}</p>
      <p class="post-count">{posts.length} article{posts.length !== 1 ? 's' : ''}</p>
    </div>
    <div class="hero-wave">
      <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
        <path d="M0 80L60 70C120 60 240 40 360 30C480 20 600 20 720 25C840 30 960 40 1080 45C1200 50 1320 50 1380 50L1440 50V80H1380C1320 80 1200 80 1080 80C960 80 840 80 720 80C600 80 480 80 360 80C240 80 120 80 60 80H0Z" fill="var(--cream)"/>
      </svg>
    </div>
  </section>

  <!-- Category Navigation -->
  <section class="category-nav">
    <div class="nav-container">
      <div class="category-pills">
        <a href="/blog" class="pill">All Posts</a>
        {allCategories.map((cat) => (
          <a
            href={`/blog/category/${cat.toLowerCase().replace(/\s+/g, '-')}`}
            class:list={['pill', { active: cat === categoryName }]}
          >
            {cat}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Posts Grid -->
  <section class="posts-section">
    <div class="posts-container">
      {posts.length > 0 ? (
        <div class="posts-grid">
          {posts.map((post, i) => (
            <div class="post-item" style={`--delay: ${i * 0.05}s`}>
              <BlogCard
                title={post.data.title}
                excerpt={post.data.excerpt}
                slug={post.id}
                date={post.data.date}
                featuredImage={post.data.featuredImage}
                categories={post.data.categories}
                readingTime={getReadingTime(post.body || '')}
              />
            </div>
          ))}
        </div>
      ) : (
        <div class="no-posts">
          <p>No posts found in this category yet.</p>
          <a href="/blog" class="back-link">View all posts</a>
        </div>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <div class="cta-container">
      <h2 class="cta-title">Ready to transform your guest WiFi?</h2>
      <p class="cta-text">Start capturing leads and automating marketing today.</p>
      <div class="cta-buttons">
        <a href="/contact" class="cta-btn-primary">Get Started Free</a>
        <a href="/features" class="cta-btn-secondary">Learn More</a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero Section */
  .category-hero {
    position: relative;
    background: linear-gradient(135deg, #fff 0%, var(--cream) 100%);
    padding: 3rem 0 4rem;
    overflow: hidden;
  }

  .hero-bg {
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(circle at 10% 20%, rgba(230, 74, 25, 0.06) 0%, transparent 50%),
      radial-gradient(circle at 90% 80%, rgba(230, 74, 25, 0.04) 0%, transparent 40%);
  }

  .hero-container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1.5rem;
    text-align: center;
    position: relative;
    z-index: 1;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-body);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .breadcrumb a {
    color: var(--charcoal-light);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .breadcrumb a:hover {
    color: var(--orange-500);
  }

  .breadcrumb .separator {
    color: var(--charcoal-light);
    opacity: 0.5;
  }

  .breadcrumb .current {
    color: var(--charcoal);
    font-weight: 500;
  }

  .hero-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
    color: var(--charcoal);
    margin-bottom: 1rem;
    animation: fadeInUp 0.6s ease forwards;
  }

  .hero-subtitle {
    font-family: var(--font-body);
    font-size: 1.1rem;
    line-height: 1.7;
    color: var(--charcoal-light);
    max-width: 600px;
    margin: 0 auto 1rem;
    animation: fadeInUp 0.6s ease 0.1s forwards;
    opacity: 0;
  }

  .post-count {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: var(--orange-500);
    font-weight: 600;
    animation: fadeInUp 0.6s ease 0.2s forwards;
    opacity: 0;
  }

  .hero-wave {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    line-height: 0;
  }

  .hero-wave svg {
    width: 100%;
    height: 40px;
  }

  /* Category Navigation */
  .category-nav {
    background: var(--cream);
    padding: 0 0 2rem;
  }

  .nav-container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .category-pills {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
  }

  .pill {
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--charcoal-light);
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.08);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .pill:hover {
    color: var(--charcoal);
    border-color: var(--orange-500);
  }

  .pill.active {
    background: var(--orange-500);
    color: white;
    border-color: var(--orange-500);
  }

  /* Posts Section */
  .posts-section {
    background: var(--cream);
    padding: 1rem 0 5rem;
  }

  .posts-container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 2rem;
  }

  @media (min-width: 640px) {
    .posts-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .posts-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .post-item {
    animation: fadeInUp 0.5s ease var(--delay) forwards;
    opacity: 0;
  }

  .no-posts {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
  }

  .no-posts p {
    font-family: var(--font-body);
    font-size: 1.1rem;
    color: var(--charcoal-light);
    margin-bottom: 1rem;
  }

  .back-link {
    font-family: var(--font-body);
    font-weight: 600;
    color: var(--orange-500);
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  /* CTA Section */
  .cta-section {
    background: var(--charcoal);
    padding: 4rem 0;
  }

  .cta-container {
    max-width: 40rem;
    margin: 0 auto;
    padding: 0 1.5rem;
    text-align: center;
  }

  .cta-title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.75rem;
  }

  .cta-text {
    font-family: var(--font-body);
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 2rem;
  }

  .cta-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .cta-btn-primary {
    font-family: var(--font-body);
    font-size: 1rem;
    font-weight: 600;
    padding: 1rem 2rem;
    background: var(--orange-500);
    color: white;
    border-radius: 50px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .cta-btn-primary:hover {
    background: var(--orange-600);
    transform: translateY(-2px);
  }

  .cta-btn-secondary {
    font-family: var(--font-body);
    font-size: 1rem;
    font-weight: 600;
    padding: 1rem 2rem;
    background: transparent;
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .cta-btn-secondary:hover {
    border-color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
